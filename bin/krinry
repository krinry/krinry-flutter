#!/bin/bash
# krinry - Multi-purpose CLI for Termux
# Usage: krinry <tool> [command] [options]
# Example: krinry flutter build apk --release
#          krinry flutter doctor
#          krinry --help

# Don't use set -e here - commands handle their own errors

# Installation directory (standard location)
KRINRY_HOME="${HOME}/.krinry"

# If running from different location, try to resolve
if [[ ! -d "${KRINRY_HOME}/lib" ]]; then
    # Fallback: resolve from script path
    SCRIPT_SOURCE="${BASH_SOURCE[0]}"
    # Follow symlinks
    while [[ -L "$SCRIPT_SOURCE" ]]; do
        LINK_TARGET="$(readlink "$SCRIPT_SOURCE" 2>/dev/null || ls -la "$SCRIPT_SOURCE" | awk '{print $NF}')"
        if [[ "$LINK_TARGET" == /* ]]; then
            SCRIPT_SOURCE="$LINK_TARGET"
        else
            SCRIPT_SOURCE="$(dirname "$SCRIPT_SOURCE")/$LINK_TARGET"
        fi
    done
    KRINRY_HOME="$(cd "$(dirname "$SCRIPT_SOURCE")/.." && pwd)"
fi

LIB_DIR="${KRINRY_HOME}/lib"
TOOLS_DIR="${KRINRY_HOME}/tools"

# Verify lib directory exists
if [[ ! -f "${LIB_DIR}/core.sh" ]]; then
    echo "Error: Cannot find krinry library at ${LIB_DIR}"
    echo "Please reinstall: curl -fsSL https://raw.githubusercontent.com/krinry/krinry-cli/main/install.sh | bash"
    exit 1
fi

# Source core library
source "${LIB_DIR}/core.sh"

# ============ Help Text ============

show_help() {
    echo ""
    echo -e "${BOLD}${CYAN}krinry${NC} v${VERSION}"
    echo "Multi-purpose CLI for mobile developers"
    echo ""
    echo -e "${BOLD}USAGE:${NC}"
    echo "  krinry <tool> [command] [options]"
    echo ""
    echo -e "${BOLD}TOOLS:${NC}"
    echo "  flutter     Flutter development & cloud builds"
    echo "  install     Install packages (flutter, neovim, etc.)"
    echo ""
    echo -e "${BOLD}GLOBAL COMMANDS:${NC}"
    echo "  --help, -h      Show this help message"
    echo "  --version, -v   Show version"
    echo "  update          Update krinry to latest version"
    echo ""
    echo -e "${BOLD}INSTALL COMMANDS:${NC}"
    echo "  krinry install flutter      Install Flutter SDK"
    echo "  krinry install neovim       Install Neovim editor"
    echo "  krinry install micro        Install Micro editor"
    echo "  krinry install <pkg>        Install any Termux package"
    echo ""
    echo -e "${BOLD}FLUTTER COMMANDS:${NC}"
    echo "  krinry flutter doctor       Check system requirements"
    echo "  krinry flutter init         Initialize cloud build"
    echo "  krinry flutter build apk    Build APK in cloud"
    echo "  krinry flutter run web      Run Flutter web server"
    echo ""
    echo -e "${BOLD}EXAMPLES:${NC}"
    echo "  krinry install flutter"
    echo "  krinry flutter build apk --release"
    echo "  krinry flutter run web"
    echo "  krinry update"
    echo ""
    echo -e "${BOLD}DOCS:${NC}"
    echo "  https://github.com/krinry/krinry-cli"
    echo ""
}

show_version() {
    echo "krinry v${VERSION}"
}

# ============ Tool Router ============

main() {
    # No arguments - show help
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi
    
    # Parse first argument
    case "$1" in
        --help|-h)
            show_help
            exit 0
            ;;
        --version|-v)
            show_version
            exit 0
            ;;
        update)
            source "${LIB_DIR}/update.sh"
            cmd_update
            ;;
        install)
            shift
            run_install_tool "$@"
            ;;
        flutter)
            shift
            run_flutter_tool "$@"
            ;;
        *)
            # Check if it's a tool in the tools directory
            if [[ -f "${TOOLS_DIR}/$1/main.sh" ]]; then
                local tool_name="$1"
                shift
                source "${TOOLS_DIR}/${tool_name}/main.sh"
                tool_main "$@"
            else
                print_error "Unknown tool: $1"
                echo "Run 'krinry --help' for available tools"
                exit 1
            fi
            ;;
    esac
}

# ============ Flutter Tool ============

run_flutter_tool() {
    # No subcommand - show flutter help
    if [[ $# -eq 0 ]]; then
        show_flutter_help
        exit 0
    fi
    
    case "$1" in
        --help|-h)
            show_flutter_help
            exit 0
            ;;
        install)
            source "${LIB_DIR}/flutter/install.sh"
            cmd_install_flutter "${@:2}"
            ;;
        doctor)
            source "${LIB_DIR}/flutter/doctor.sh"
            cmd_doctor "${@:2}"
            ;;
        init)
            source "${LIB_DIR}/flutter/init.sh"
            cmd_init "${@:2}"
            ;;
        build)
            shift
            source "${LIB_DIR}/flutter/build.sh"
            if [[ "$1" == "apk" ]]; then
                cmd_build "apk" "${@:2}"
            elif [[ "$1" == "appbundle" || "$1" == "aab" ]]; then
                cmd_build "appbundle" "${@:2}"
            elif [[ -z "$1" || "$1" == --* ]]; then
                # No target specified, default to apk
                cmd_build "apk" "$@"
            else
                print_error "Unknown build target: $1"
                echo ""
                echo "Usage: krinry flutter build <target> [options]"
                echo ""
                echo "Targets:"
                echo "  apk        Build Android APK"
                echo "  appbundle  Build Android App Bundle (AAB)"
                echo ""
                echo "Options:"
                echo "  --debug    Debug build (default)"
                echo "  --profile  Profile build"
                echo "  --release  Release build"
                echo "  --split    Split APK by ABI"
                echo "  --arm64    ARM64 only"
                echo "  --arm      ARM only"
                echo "  --x64      x64 only"
                echo "  --install  Install on device after build"
                exit 1
            fi
            ;;
        run)
            shift
            source "${LIB_DIR}/flutter/run.sh"
            cmd_run "${@}"
            ;;
        *)
            print_error "Unknown flutter command: $1"
            echo "Run 'krinry flutter --help' for usage"
            exit 1
            ;;
    esac
}

show_flutter_help() {
    echo ""
    echo -e "${BOLD}${CYAN}krinry flutter${NC}"
    echo "Flutter development & cloud builds for Termux"
    echo ""
    echo -e "${BOLD}USAGE:${NC}"
    echo "  krinry flutter <command> [options]"
    echo ""
    echo -e "${BOLD}COMMANDS:${NC}"
    echo "  install            Install Flutter SDK for Termux"
    echo "  doctor             Check system requirements"
    echo "  init               Initialize cloud build in Flutter project"
    echo "  build apk          Build APK using cloud (GitHub Actions)"
    echo "  build appbundle    Build AAB using cloud (GitHub Actions)"
    echo "  run web            Run Flutter web server (local)"
    echo ""
    echo -e "${BOLD}BUILD OPTIONS:${NC}"
    echo "  --debug            Debug build (default)"
    echo "  --profile          Profile build"
    echo "  --release          Release build"
    echo "  --split-per-abi    Split APK by ABI"
    echo "  --target-platform  Target specific platform"
    echo "  --install          Install on device after download"
    echo ""
    echo -e "${BOLD}EXAMPLES:${NC}"
    echo "  krinry flutter build apk              # Debug APK"
    echo "  krinry flutter build apk --release    # Release APK"
    echo "  krinry flutter build apk --split-per-abi  # Split APKs"
    echo "  krinry flutter build appbundle        # App Bundle"
    echo "  krinry flutter build apk --install    # Build & install"
    echo ""
}

# ============ Install Tool ============

run_install_tool() {
    # No package - show help
    if [[ $# -eq 0 ]]; then
        show_install_help
        exit 1
    fi
    
    local package="$1"
    shift
    
    case "$package" in
        flutter)
            source "${LIB_DIR}/flutter/install.sh"
            cmd_install_flutter
            ;;
        --help|-h)
            show_install_help
            ;;
        *)
            # Generic package install
            source "${LIB_DIR}/install.sh"
            cmd_install_package "$package"
            ;;
    esac
}

show_install_help() {
    echo ""
    echo -e "${BOLD}${CYAN}krinry install${NC}"
    echo "Install packages with krinry"
    echo ""
    echo -e "${BOLD}USAGE:${NC}"
    echo "  krinry install <package>"
    echo ""
    echo -e "${BOLD}SPECIAL PACKAGES:${NC}"
    echo "  flutter      Flutter SDK for app development"
    echo "  shell-tools  All shell enhancements (recommended!)"
    echo ""
    echo -e "${BOLD}SHELL TOOLS:${NC}"
    echo "  fish         Auto-suggestions shell (recommended)"
    echo "  zsh          Z Shell"
    echo "  oh-my-zsh    Zsh framework with themes"
    echo "  thefuck      Corrects wrong commands"
    echo ""
    echo -e "${BOLD}EDITORS:${NC}"
    echo "  neovim       Powerful text editor"
    echo "  micro        Modern terminal editor"
    echo "  nano         Simple text editor"
    echo "  vim          Classic text editor"
    echo ""
    echo -e "${BOLD}EXAMPLES:${NC}"
    echo "  krinry install flutter"
    echo "  krinry install shell-tools   # Fish + Zsh + TheFuck + Fzf"
    echo "  krinry install fish"
    echo "  krinry install neovim"
    echo ""
    echo -e "${DIM}Powered by krinry â€¢ Packages from TermuxVoid${NC}"
    echo ""
}

# Run main
main "$@"
